<!DOCTYPE html>
<html lang="en">
    <head>
    	<title>Mars Rover</title>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        
	</head>
	<body>

		<style>

			.command-panel, .data-panel {
				width: 500px;
				margin: 0 auto;
				text-align: center;
				border: 1px solid gray;
				padding: 40px;
				border-radius: 2px;
				margin-top: 30px;
			}

			span {
				letter-spacing: 2px;
			}
		</style>

		<div class="command-panel">
			<h2>Send commands</h2>
			<input type="file" name="data" id="data">
		</div>

		<div class="data-panel" id=data-panel>
		</div>
		


		<script src="mars-rover.js"></script>
		<script>

			// Element selectors
			const dataPanel = document.querySelector('#data-panel');
			const commandFile = document.querySelector('input[type="file"]');

			/**
			 * The assignValues function gives each rover its values based on the text file data
			 * @param  {[type]} rovers        An array of rover objects.
			 * @param  {[type]} roversArray   An array of rover positions from the text file.
			 * @param  {[type]} commandsArray An array of rover commands from the text file.
			 * @param  {[type]} obstacles     An array of rover locations as obstacles.
			 * @return {[void]}
			 */
			function assignPositionsAndObstacles(rovers, positions, commands) {

					// Rover ID counter
					var counter = 0;
					var obstacles = [];

					// For each rover object in the rovers array
					for(var i = 0; i < rovers.length; i++) {

						// Parse their locations (x,y) to int
						rovers[i].position = [parseInt(positions[i].split(' ')[0]), parseInt(positions[i].split(' ')[1]), positions[i].split(' ')[2]];

						// Make each rover navigate with their corresponding commands
						rovers[i].navigate(rovers[i].commands);

						obstacles.push({x: rovers[i].position[0], y: rovers[i].position[1]});

						rovers[i].obstacles = obstacles;

						// Increment their ID
						counter += 1;
						rovers[i].ID = counter;

						
						// Append a line to the DOM confirming each rover's final position
						var position = document.createElement('h4');
						position.innerHTML = `Rover ${rovers[i].ID}'s final position is: ${rovers[i].position}`;
						dataPanel.appendChild(position);
					}
			}

				
			/**
			 * [assignObstacles description]
			 * @param  {[type]} positions [description]
			 * @return {[type]}           [description]
			 */
			function excludeOwnAsObstacle(rovers) {

				

				// For each rover object in the rovers array
				for(var i = 0; i < rovers.length; i++) { 
					console.log(rovers[i].obstacles);
					// Find all other rover positions (except its own)
					
					let obstacles = rovers[i].obstacles.filter(obj => {

						return (rovers[i].position[0] !== obj.x && rovers[i].position[1] !== obj.y)

					});

					// Assign its obstacles to all other rover positions
					rovers[i].obstacles = obstacles;
				}
			}
			

			/**
			 * [getCommands description]
			 * @param  {[type]} lines [description]
			 * @return {[type]}       [description]
			 */
			function getCommands(lines) {

				// An array with commands only
				return lines.filter((element, index) => {
					// Remove the risk of empty strings being returned when it reaches the end of the file
				  	return index % 2 !== 0 && index != null;
				});	
			}

			/**
			 * [getPositions description]
			 * @param  {[type]} lines [description]
			 * @return {[type]}       [description]
			 */
			function getPositions(lines) {
				// An array with rover positions only
				return roversPositions = lines.filter((element, index) => {
				  	return index % 2 === 0;
				});
			}



			/**
			 * [createPlateaucreateRovers description]
			 * @param  {[type]} line [description]
			 * @return {[type]}      [description]
			 */
			function createPlateau(line) {

				// Split plateau values
		        let plateauSize = line.split(' ');

		        return new Plateau(parseInt(plateauSize[0]), parseInt(plateauSize[1]));
			}

			/**
			 * [createRovers description]
			 * @param  {[type]} lines   [description]
			 * @param  {[type]} plateau [description]
			 * @return {[type]}         [description]
			 */
			function createRovers(positions, plateau) {

				// For each line in the positions array, create a rover object
				return positions.map((pos, index) => {
					var position = pos.split(' ');
					return new MarsRover(position, plateau);
				});
			}

			/**
			 * [execute description]
			 * @param  {[type]} rovers   [description]
			 * @param  {[type]} commands [description]
			 * @return {[type]}          [description]
			 */
			function execute(rovers, commands) {

				// For each rover, assign it with a command for each line of commands
				return rovers.map((rover, index) => {
					return commands.map((command, index) => {
						rovers[index].commands = commands[index].toLowerCase();
					});
				});
			}


			/**
			 * [processFile description]
			 * @param  {[type]}   file     [description]
			 * @param  {Function} callback [description]
			 * @return {[type]}            [description]
			 */
			function processFile(file, callback) {

				var reader = new FileReader();

				reader.onload = callback;

				// Read the file
		        reader.readAsText(file);
			}


			/**
			 * [main description]
			 * @return {[type]} [description]
			 */
			function main() {

				let file = this.files[0];

				// Call back function
		        var callback = function(progressEvent) {

		            // Split each line in the text file
		            let lines = this.result.split('\n');

		            // Plateau size = first line in the text file
		            var plateau = createPlateau(lines[0]);

		            // Remove the plateau size
    				lines.shift();

    				// Retrieve positions from file
    				var positions = getPositions(lines);

    				// Retrieve commands from file
    				var commands = getCommands(lines);


    				// Array of rovers
    				var rovers = createRovers(positions, plateau);
    				console.log(rovers);

    				// Map commands into each rover
    				execute(rovers, commands);

    				// Move the rovers
    				assignPositionsAndObstacles(rovers, positions, commands);
    				excludeOwnAsObstacle(rovers);

					// Reset file upload field to clear value for new one
		            commandFile.value = null;
		        };

		        // Read the file and run call back
		        processFile(file, callback);

			}


			// Listener for file upload
			commandFile.addEventListener('change', main);

		</script>
	</body>
</html>