<!DOCTYPE html>
<html lang="en">
    <head>
    	<title>Mars Rover</title>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        
	</head>
	<body>

		<style>

			.command-panel, .data-panel {
				width: 500px;
				margin: 0 auto;
				text-align: center;
				border: 1px solid gray;
				padding: 40px;
				border-radius: 2px;
				margin-top: 30px;
			}

			span {
				letter-spacing: 2px;
			}
		</style>

		<div class="command-panel">
			<h2>Send commands</h2>
			<input type="file" name="data" id="data">
		</div>

		<div class="data-panel" id=data-panel>
		</div>
		


		<script src="mars-rover.js"></script>
		<script>

			// Element selectors
			const dataPanel = document.querySelector('#data-panel');
			const commandFile = document.querySelector('input[type="file"]');

			/**
			 * Send commands to the rover.
			 */
			function setCommands() {

				let file = this.files[0],
		        reader = new FileReader();
		       

		        reader.onload = function(progressEvent) {

		            // Split each line
		            let lines = this.result.split('\n');

		            // Split plateau values
			        let plateauSize = lines[0].split(' ');
			        this.plateau = [parseInt(plateauSize[0]), parseInt(plateauSize[1])];

		            // Remove the plateau value
        			lines.shift();


					// An array with rover positions only
					let roversArray = lines.filter((element, index) => {
					  	return index % 2 === 0;
					});

					// An array with commands only
					let commandsArray = lines.filter((element, index) => {
						// Remove the risk of empty strings being returned when it reaches the end of the file
					  	return index % 2 !== 0 && index != null;
					});

					// Array holding rover objects
					var rovers = [];

					// For each rover direction in the text file
					for(var c = 0; c < roversArray.length; c++) {
						// Create a new rover
						var rover = new MarsRover();
						// Push the rover into a rovers array
						rovers.push(rover);
					}

					// Empty obstacles array
					var obstacles = [];

			
	

					// Rover ID counter
					var counter = 0;

					// For each rover object in the rovers array
					for(var i = 0; i < rovers.length; i++) {
						// For each rover position in the text file
						for(var k = 0; k < roversArray.length; k++) {
							// For each rover command line in the text file
							for(var l = 0; l < commandsArray.length; l++) {
								// Adjust each rover object their values
								rovers[i].direction = roversArray[i].split(' ')[2];
								rovers[i].location = [parseInt(roversArray[i].split(' ')[0]), parseInt(roversArray[i].split(' ')[1])];
								rovers[i].position = [parseInt(roversArray[i].split(' ')[0]), parseInt(roversArray[i].split(' ')[1]), roversArray[i].split(' ')[2]];
								rovers[i].commands = commandsArray[i].toLowerCase();
								rovers[i].plateau = this.plateau;
								rovers[i].obstacles = obstacles;
							}	
						}

						// Increment their ID
						counter += 1;
						rovers[i].ID = counter;

						
						// Map each rover location into an obstacle array object
						obstacles.push({x: rovers[i].location[0], y: rovers[i].location[1]});

						// But filter out their own location
						// var ownLocation = rovers.filter(function(obj) {
						//   	return obj.ID == rovers[i].ID;
						// });


						// console.log(ownLocation);
						// Make each rover navigate with their corresponding commands
						rovers[i].navigate(rovers[i].commands);

						// Append a line to the HTML file confirming each rover's final position
						var position = document.createElement('h4');
						position.innerHTML = `Rover ${rovers[i].ID}'s final position is: ${rovers[i].position}`;
						dataPanel.appendChild(position);

						// Discard each rover's own ID 
						var obstacle = rovers.filter(function(obj) {
							return obj.ID == rovers[i].ID;
						});
					}

						


					

					// Create a plateau holding rovers and their locations as obstacles, from the text file
					var plateau = new Plateau(rovers, obstacles);
	

					// console.log(obstacles);
					console.log(plateau);


					// Reset file upload field to clear value for new one
		            commandFile.value = null;

		        };

		        reader.readAsText(file);
			}


			// Listener for file upload
			commandFile.addEventListener('change', setCommands);

		</script>
	</body>
</html>